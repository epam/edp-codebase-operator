apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-ci-default
  labels:
    app.edp.epam.com/ci-template: gitlab
    {{- include "codebase-operator.labels" . | nindent 4 }}
data:
  # Read by krci-portal for template selection UI; not consumed by the operator.
  description: |
    Default KubeRocketCI GitLab CI orchestration template.
    Uses the generic ci-template component library (alpine:latest).
    For tech-specific pipelines, create a custom ConfigMap and select it
    via the app.edp.epam.com/gitlab-ci-template annotation on the Codebase CR.
  .gitlab-ci.yml: |
    # ============================================================================
    # GITLAB CI/CD COMPONENT LIBRARY - ORCHESTRATION FILE
    # ============================================================================
    # This file orchestrates the conditional inclusion of review and build
    # pipelines based on the pipeline trigger source.
    #
    # AUTO-GENERATED by KubeRocketCI codebase-operator.
    # Project: {{.CodebaseName}}
    #
    # HOW IT WORKS:
    #   This file uses GitLab CI/CD Components — reusable pipeline building
    #   blocks hosted as GitLab projects. Each component exposes "review"
    #   and "build" entry points with parameterized inputs.
    #   Docs: https://docs.gitlab.com/ci/components/
    #
    # TEMPLATE SELECTION:
    #   The operator resolves this template from ConfigMaps in the namespace:
    #     1. If the Codebase CR has the annotation
    #        app.edp.epam.com/gitlab-ci-template=<name>, that ConfigMap is used.
    #     2. Otherwise, gitlab-ci-default (this file) is used as fallback.
    #   To use a tech-specific template, create a ConfigMap and set the
    #   annotation on the Codebase CR to its name.
    #
    # AVAILABLE COMPONENT LIBRARIES (https://gitlab.com/kuberocketci):
    #   ci-template       — Base/generic        (alpine:latest)
    #   ci-golang         — Go                  (golang:1.24-bookworm)
    #   ci-java17-mvn     — Java 17 Maven       (maven:3.9-eclipse-temurin-17)
    #   ci-java17-gradle  — Java 17 Gradle      (gradle:8-jdk17)
    #   ci-nodejs-npm     — Node.js / npm        (node:20-alpine)
    #   ci-python-uv      — Python / uv          (python:3.13-slim)
    #
    # PIPELINE ARCHITECTURE:
    #   All component libraries follow a mandatory 7-stage flow:
    #     prepare → test → build → verify → package → publish → release
    #
    #   Review pipeline (merge requests):  prepare → test → build → verify
    #   Build pipeline  (protected branch): prepare → test → build → package → publish
    #   Release         (semantic tag):     release stage only
    #
    #   Quality gate chain: test → build → sonar → docker
    #   Parallel jobs:      lint, type-check, helm-docs, helm-lint
    # ============================================================================

    # ============================================================================
    # WORKFLOW RULES
    # ============================================================================
    # Controls when pipelines are triggered. Standard across all tech stacks.
    # Docs: https://docs.gitlab.com/ci/yaml/#workflowrules
    workflow:
      rules:
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
        - if: $CI_COMMIT_REF_PROTECTED == "true"
        - if: $CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/

    # ============================================================================
    # GLOBAL VARIABLES - CUSTOMIZE FOR YOUR PROJECT
    # ============================================================================
    variables:
      CODEBASE_NAME: "{{.CodebaseName}}"

      # Container image for build/test jobs.
      # This default uses the generic ci-template component library.
      # Replace with a tech-specific image when switching to a
      # tech-specific component library (see AVAILABLE COMPONENT LIBRARIES above).
      CONTAINER_IMAGE: "alpine:latest"

      # Container registry for publishing Docker images.
      IMAGE_REGISTRY: "docker.io/myorg"

      # SonarQube organization (optional).
      # Project key: ${SONAR_ORG}_${CODEBASE_NAME} (or just ${CODEBASE_NAME}).
      SONAR_ORG: "myorg"

      # Helm chart directory.
      CHART_DIR: "deploy-templates"

    # ============================================================================
    # COMPONENT INCLUSION
    # ============================================================================
    # Components are included conditionally based on the pipeline trigger.
    # Replace "kuberocketci/ci-template" with a tech-specific library
    # and update CONTAINER_IMAGE accordingly. For example, for Go:
    #   component: $CI_SERVER_FQDN/kuberocketci/ci-golang/review@0.1.0
    #   go_image: golang:1.24-bookworm      (instead of container_image)
    #
    # Docs: https://docs.gitlab.com/ci/components/#use-a-component
    include:
      # REVIEW — merge request validation (no publishing)
      - component: $CI_SERVER_FQDN/kuberocketci/ci-template/review@0.1.0
        inputs:
          stage_prepare: prepare
          stage_test: test
          stage_build: build
          stage_verify: verify
          codebase_name: ${CODEBASE_NAME}
          container_image: ${CONTAINER_IMAGE}
          chart_dir: ${CHART_DIR}
        rules:
          - if: $CI_PIPELINE_SOURCE == "merge_request_event"

      # BUILD — protected-branch build, package, and publish
      - component: $CI_SERVER_FQDN/kuberocketci/ci-template/build@0.1.0
        inputs:
          stage_prepare: prepare
          stage_test: test
          stage_build: build
          stage_package: package
          stage_publish: publish
          codebase_name: ${CODEBASE_NAME}
          container_image: ${CONTAINER_IMAGE}
          image_registry: ${IMAGE_REGISTRY}
          chart_dir: ${CHART_DIR}
        rules:
          - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_REF_PROTECTED == "true"

    # ============================================================================
    # STAGES
    # ============================================================================
    stages: [prepare, test, build, verify, package, publish, release]

    # GitLab requires at least one visible job definition in the orchestration
    # file for lint validation. This job never runs.
    visible-job-lint-fix:
      stage: .pre
      rules: [when: never]
      script: [echo "placeholder"]

    # ============================================================================
    # RELEASE
    # ============================================================================
    # Creates a GitLab release when a semantic version tag is pushed.
    # Docs: https://docs.gitlab.com/ee/user/project/releases/release_cli.html
    create-release:
      stage: release
      image: registry.gitlab.com/gitlab-org/release-cli:latest
      rules:
        - if: $CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+$/
      script: echo "Creating release $CI_COMMIT_TAG"
      release:
        tag_name: $CI_COMMIT_TAG
        description: "Release $CI_COMMIT_TAG of $CI_PROJECT_PATH"

    # ============================================================================
    # REQUIRED CI/CD VARIABLES
    # ============================================================================
    # Configure in GitLab: Settings > CI/CD > Variables
    # Docs: https://docs.gitlab.com/ci/variables/#define-a-cicd-variable-in-the-ui
    #
    # SONARQUBE:
    #   SONAR_HOST_URL       — SonarQube/SonarCloud server URL
    #   SONAR_TOKEN          — Authentication token (protected, masked)
    #
    # DOCKER REGISTRY:
    #   DOCKERHUB_USERNAME   — Registry username
    #   DOCKERHUB_PASSWORD   — Registry password or token (protected, masked)
    #
    # GIT TAGGING:
    #   GITLAB_ACCESS_TOKEN  — Token with write_repository scope (protected, masked)
    #
    # OPTIONAL:
    #   GITLAB_USER_EMAIL    — Email for CI commits (default: ci-bot@example.com)
    #   GITLAB_USER_NAME     — Name for CI commits  (default: GitLab CI)
    #
    # TECH-SPECIFIC (add as needed):
    #   NPM_TOKEN            — npm registry token (Node.js)
    #   MAVEN_REPOSITORY_URL — Maven repo URL (Java Maven)
    #   GRADLE_REPOSITORY_URL — Gradle repo URL (Java Gradle)
    #   PYPI_TOKEN           — PyPI token (Python)

    # ============================================================================
    # CUSTOMIZATION GUIDE
    # ============================================================================
    # 1. Replace ci-template component references with a tech-specific library:
    #
    #    Component Library         Container Image               Docs
    #    ─────────────────────────────────────────────────────────────────────
    #    kuberocketci/ci-golang         golang:1.24-bookworm     https://gitlab.com/kuberocketci/ci-golang
    #    kuberocketci/ci-java17-mvn     maven:3.9-eclipse-temurin-17  https://gitlab.com/kuberocketci/ci-java17-mvn
    #    kuberocketci/ci-java17-gradle  gradle:8-jdk17           https://gitlab.com/kuberocketci/ci-java17-gradle
    #    kuberocketci/ci-nodejs-npm     node:20-alpine           https://gitlab.com/kuberocketci/ci-nodejs-npm
    #    kuberocketci/ci-python-uv      python:3.13-slim         https://gitlab.com/kuberocketci/ci-python-uv
    #
    # 2. Update CONTAINER_IMAGE (or the tech-specific input like go_image)
    # 3. Set IMAGE_REGISTRY to your container registry
    # 4. Configure SONAR_ORG for your SonarQube organization
    # 5. Add required CI/CD variables in GitLab project settings
